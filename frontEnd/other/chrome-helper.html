<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>谷歌浏览器开发 | DripFlows</title>
    <meta name="description" content="待补充">
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
    
    <link rel="preload" href="/assets/css/0.styles.28ef1fef.css" as="style"><link rel="preload" href="/assets/js/app.7355eab2.js" as="script"><link rel="preload" href="/assets/js/2.132a57af.js" as="script"><link rel="preload" href="/assets/js/18.fb2319df.js" as="script"><link rel="prefetch" href="/assets/js/10.740b5f64.js"><link rel="prefetch" href="/assets/js/11.78082b06.js"><link rel="prefetch" href="/assets/js/12.96589dd2.js"><link rel="prefetch" href="/assets/js/13.82b7dda1.js"><link rel="prefetch" href="/assets/js/14.6c0337ad.js"><link rel="prefetch" href="/assets/js/15.4580a59e.js"><link rel="prefetch" href="/assets/js/16.dd06d4f0.js"><link rel="prefetch" href="/assets/js/17.7ce49614.js"><link rel="prefetch" href="/assets/js/19.29154b75.js"><link rel="prefetch" href="/assets/js/20.ba78d04c.js"><link rel="prefetch" href="/assets/js/21.edc9c9c6.js"><link rel="prefetch" href="/assets/js/22.777eaed4.js"><link rel="prefetch" href="/assets/js/23.d05fe0b4.js"><link rel="prefetch" href="/assets/js/24.7ae352e2.js"><link rel="prefetch" href="/assets/js/25.f458ff03.js"><link rel="prefetch" href="/assets/js/26.02148a11.js"><link rel="prefetch" href="/assets/js/27.e92b4339.js"><link rel="prefetch" href="/assets/js/28.316df1f3.js"><link rel="prefetch" href="/assets/js/29.7ca7db8a.js"><link rel="prefetch" href="/assets/js/3.4df34556.js"><link rel="prefetch" href="/assets/js/30.eed17a97.js"><link rel="prefetch" href="/assets/js/31.91dad760.js"><link rel="prefetch" href="/assets/js/32.8d597ba3.js"><link rel="prefetch" href="/assets/js/33.16a09da9.js"><link rel="prefetch" href="/assets/js/34.45c4d2e6.js"><link rel="prefetch" href="/assets/js/4.663fdb84.js"><link rel="prefetch" href="/assets/js/5.ed1cff9d.js"><link rel="prefetch" href="/assets/js/6.a180e42e.js"><link rel="prefetch" href="/assets/js/7.101c3ea0.js"><link rel="prefetch" href="/assets/js/8.38b06e0d.js"><link rel="prefetch" href="/assets/js/9.5d56b8fe.js">
    <link rel="stylesheet" href="/assets/css/0.styles.28ef1fef.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">DripFlows</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">🌟博客</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/frontEnd/" class="nav-link router-link-active">前端</a></li><li class="dropdown-item"><!----> <a href="/backEnd/" class="nav-link">后端</a></li><li class="dropdown-item"><!----> <a href="/tools/" class="nav-link">工具</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">💻项目</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/DripFlows/chrome-helper" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Chrome-helper
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div><div class="nav-item"><a href="/suggestions/" class="nav-link">📚推荐</a></div><div class="nav-item"><a href="/todo/" class="nav-link">💡Todo</a></div><div class="nav-item"><a href="https://github.com/DripFlows" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">🌟博客</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/frontEnd/" class="nav-link router-link-active">前端</a></li><li class="dropdown-item"><!----> <a href="/backEnd/" class="nav-link">后端</a></li><li class="dropdown-item"><!----> <a href="/tools/" class="nav-link">工具</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">💻项目</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/DripFlows/chrome-helper" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Chrome-helper
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div><div class="nav-item"><a href="/suggestions/" class="nav-link">📚推荐</a></div><div class="nav-item"><a href="/todo/" class="nav-link">💡Todo</a></div><div class="nav-item"><a href="https://github.com/DripFlows" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/frontEnd/" class="sidebar-link">欢迎</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JavaScript</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>TypeScript</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Node</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>React</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Vue</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>杂类</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/frontEnd/other/use-blog.html" class="sidebar-link">DripFlows博客使用规范</a></li><li><a href="/frontEnd/other/start-vuepress-plugin.html" class="sidebar-link">vuepress-plugin开发总结</a></li><li><a href="/frontEnd/other/chrome-helper.html" class="active sidebar-link">记一次谷歌浏览器截图插件开发</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/frontEnd/other/chrome-helper.html#起因" class="sidebar-link">起因</a></li><li class="sidebar-sub-header"><a href="/frontEnd/other/chrome-helper.html#基础" class="sidebar-link">基础</a></li><li class="sidebar-sub-header"><a href="/frontEnd/other/chrome-helper.html#项目结构" class="sidebar-link">项目结构</a></li><li class="sidebar-sub-header"><a href="/frontEnd/other/chrome-helper.html#代码示例" class="sidebar-link">代码示例</a></li><li class="sidebar-sub-header"><a href="/frontEnd/other/chrome-helper.html#调试" class="sidebar-link">调试</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/frontEnd/other/chrome-helper.html#调试content-script" class="sidebar-link">调试Content Script</a></li><li class="sidebar-sub-header"><a href="/frontEnd/other/chrome-helper.html#调试background" class="sidebar-link">调试Background</a></li><li class="sidebar-sub-header"><a href="/frontEnd/other/chrome-helper.html#调试popup" class="sidebar-link">调试Popup</a></li><li class="sidebar-sub-header"><a href="/frontEnd/other/chrome-helper.html#调试inject" class="sidebar-link">调试inject</a></li></ul></li><li class="sidebar-sub-header"><a href="/frontEnd/other/chrome-helper.html#总结" class="sidebar-link">总结</a></li></ul></li><li><a href="/frontEnd/other/electron-record.html" class="sidebar-link">写一个electron的录屏工具</a></li><li><a href="/frontEnd/other/vscode-tree-view.html" class="sidebar-link">vscode插件开发之侧边栏</a></li><li><a href="/frontEnd/other/blog-record.html" class="sidebar-link">博客记录</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>算法</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="记一次谷歌浏览器截图插件开发"><a href="#记一次谷歌浏览器截图插件开发" aria-hidden="true" class="header-anchor">#</a> 记一次谷歌浏览器截图插件开发</h1> <h2 id="起因"><a href="#起因" aria-hidden="true" class="header-anchor">#</a> 起因</h2> <p>因为公司有个需求，就是需要在网页上进行截图报错，既然领导任务经分配下来，那小弟当然就屁颠屁颠跑去调研了。接了任务之后，心中先预想了几种能够实现的方案。</p> <ol><li>让用户用自己的截图工具（微信/qq等）截图之后提供一个上传的入口</li> <li>用js来做截图功能</li> <li>写一个截图工具</li></ol> <p>当然，身为一个前端小菜鸟，当然先去想通过前端方案去怎么实现了。第一步头脑风暴（其实是百度）了一下js怎么实现网页截图，经过头脑风暴，果然发现js本身是没有截图的api的，但是自然是难不住伟大的程序员的，看到网上其他的js截图方案，大同小异，基本都是把dom元素写入到canvas上，然后把canvas转为img，俺想，这简单啊，网上找个轮子，来自己做一下就成了，心里美滋滋的找了html2canvas插件，然后经过一番折腾之后，发现了这种方案的弊端</p> <ol><li>无法截取iframe里的内容，原因是在把dom画入到canvas上的时候，js无法把iframe里的dom节点画入</li> <li>跨域资源图片也无法截图，原因是出于浏览器安全策略，不允许这未经许可拉取远程网站信息而导致的用户隐私泄露</li> <li>截图不清晰（这个点影响不算大，可以接收）</li></ol> <p>发现这个三个问题之后，回头看项目，得，这方案没法用了，项目中各种iframe嵌套（小声逼逼）。在找了下，没有找到其他更好的轮子了。于是乎，开始找产品扯皮。一顿巴拉巴拉之后（给产品洗脑安利方案一emmmmm）没成功，产品说方案一用户操作成本太高，体验不好。于是不得已抬出方案三（没做过这种插件，心里没底），然后经过一顿瞎逼分析之后，得出以下几个优劣势：</p> <ol><li>需要额外的安装插件，用户的学习成本和技术支持的额外支出（比较明显的一个缺点）</li> <li>可拓展性强，以后还可以在此基础上拓展其它功能（可持续发展道路）</li> <li>可维护性，可以作为一个独立的项目</li> <li>逼格高（emmmm）</li></ol> <h2 id="基础"><a href="#基础" aria-hidden="true" class="header-anchor">#</a> 基础</h2> <ol><li>创建manifest.json,这是插件的元数据，插件的配置信息，任何插件都必须要有这个文件，任何插件都必须要有这个文件</li></ol> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;manifest_version&quot;</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
  <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;插件名&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1.0&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 用来判断是否需要更新</span>
  <span class="token property">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;插件描述&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;browser_action&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;default_icon&quot;</span><span class="token operator">:</span> <span class="token string">&quot;static/favicon.ico&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 插件图标</span>
      <span class="token property">&quot;default_title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;插件图标上显示的内容&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;default_popup&quot;</span><span class="token operator">:</span> <span class="token string">&quot;pages/popup.html&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;background&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">// 后台运行的js，相当于后台进程</span>
      <span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;scripts/background.js&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">&quot;persistent&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;permissions&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token comment">// 授权信息 - 那些网站或者其他tab的授权</span>
    <span class="token string">&quot;tabs&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;unlimitedStorage&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;notifications&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;history&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;activeTab&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;storage&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;webRequestBlocking&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;*://*/*&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;http://*/*&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;https://*/*&quot;</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;web_accessible_resources&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token comment">// 注入到网页的内容</span>
      <span class="token string">&quot;scripts/inject.js&quot;</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;content_scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> <span class="token comment">// 内容js</span>
      <span class="token property">&quot;matches&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;http://*/*&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;https://*/*&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;*://*/*&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 匹配那些网站</span>
      <span class="token property">&quot;js&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;scripts/jquery.min.js&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;scripts/inject.js&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">&quot;run_at&quot;</span><span class="token operator">:</span> <span class="token string">&quot;document_start&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="项目结构"><a href="#项目结构" aria-hidden="true" class="header-anchor">#</a> 项目结构</h2> <div class="language-bash extra-class"><pre class="language-bash"><code>    ├── scripts                         脚本内容
    │   ├── background.js
    │   ├── index.js
    │   ├── inject.js
    │   ├── jquery.min.js
    │   ├── popup.js
    ├── pages                           页面内容（弹出页，背景页）
    ├── static                          静态资源文件
    ├── styles                          样式
    ├── manifest.json                   chrome插件配置
    ├── README.md                       项目描述文件
</code></pre></div><h2 id="代码示例"><a href="#代码示例" aria-hidden="true" class="header-anchor">#</a> 代码示例</h2> <ol><li>popup.html 点击图标显示的内容, 在browser_action.default_popup 设置</li></ol> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>CaptureScreen<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>网页截图<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>../scripts/index.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><ol start="3"><li>scripts/index.js 入口页</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> $CaptureScreenBtn <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'.CaptureScreen'</span><span class="token punctuation">)</span> <span class="token comment">// 截屏按钮</span>
<span class="token keyword">const</span> popup <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// 初始化</span>
  <span class="token function">_init</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_initialEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_initScript</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// 事件初始化</span>
  <span class="token function">_initialEvent</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    $CaptureScreenBtn<span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleCaptureScreen<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// 脚本初始化</span>
  <span class="token function">_initScript</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_sendMsg</span><span class="token punctuation">(</span><span class="token punctuation">{</span> action<span class="token punctuation">:</span> <span class="token string">'INJECT_SCRIPT'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// 发送消息,和html通讯</span>
  <span class="token function">_sendMsg</span> <span class="token punctuation">(</span><span class="token parameter">message<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 对runtime发送消息</span>
    chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>callback<span class="token punctuation">)</span> <span class="token function">callback</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// 接收消息</span>
  <span class="token function">_getMsg</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 监听runtime中的信息</span>
    chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>onMessage<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> sender<span class="token punctuation">,</span> sendResponse</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">switch</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span>action<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">default</span><span class="token punctuation">:</span>
          <span class="token keyword">break</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// 开始截屏</span>
  <span class="token function">handleCaptureScreen</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 获取当前窗口 -&gt; 回调函数包括当前窗口的详细信息，如窗口id等</span>
    chrome<span class="token punctuation">.</span>windows<span class="token punctuation">.</span><span class="token function">getCurrent</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">win</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 抓取当前tab的内容</span>
      chrome<span class="token punctuation">.</span>tabs<span class="token punctuation">.</span><span class="token function">captureVisibleTab</span><span class="token punctuation">(</span>win<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">dataUrl</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> info <span class="token operator">=</span> <span class="token punctuation">{</span>
          action<span class="token punctuation">:</span> <span class="token string">'CAPTURE_SCREEN'</span><span class="token punctuation">,</span>
          payload<span class="token punctuation">:</span> dataUrl
        <span class="token punctuation">}</span>
        popup<span class="token punctuation">.</span><span class="token function">_sendMsg</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="4"><li>scripts/background.js</li></ol> <ul><li>后台进程，用于监听消息和转发消息</li> <li>可以操作html</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 消息群集</span>
chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>onMessage<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span>onRuntimeMessage<span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">sendPostMsg</span> <span class="token punctuation">(</span><span class="token parameter">info</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  window<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'*'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 监听runtime消息</span>
<span class="token comment">/**
 * @param {*} request
 * @param {*} sender
 * @param {*} sendResponse
 */</span>
<span class="token keyword">function</span> <span class="token function">onRuntimeMessage</span> <span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> _<span class="token punctuation">,</span> sendResponse</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Tips: 需要sendResponse,不然可能会阻塞其他消息</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> action<span class="token punctuation">,</span> payload <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span>
  <span class="token function">sendResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 向网页注入js代码</span>
<span class="token keyword">function</span> <span class="token function">injectScript</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> link <span class="token operator">=</span> <span class="token string">'scripts/inject.js'</span>
  <span class="token keyword">const</span> temp <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'script'</span><span class="token punctuation">)</span>
  temp<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'type'</span><span class="token punctuation">,</span> <span class="token string">'text/javascript'</span><span class="token punctuation">)</span>
  <span class="token comment">// 获得的地址类似：chrome-extension://ihcokhadfjfchaeagdoclpnjdiokfakg/js/inject.js</span>
  temp<span class="token punctuation">.</span>src <span class="token operator">=</span> chrome<span class="token punctuation">.</span>extension<span class="token punctuation">.</span><span class="token function">getURL</span><span class="token punctuation">(</span>link<span class="token punctuation">)</span>
  temp<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 放在页面不好看，执行完后移除掉</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  document<span class="token punctuation">.</span>head<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>temp<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="5"><li>scripts/inject.js 此代码会注入到网页，所以在这边做为插件和网页的桥梁，通过postmessage来交互</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 监听消息</span>
window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> receivedMessage<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>

<span class="token comment">// 发送postmessage消息</span>
<span class="token keyword">function</span> <span class="token function">sendPostMsg</span> <span class="token punctuation">(</span><span class="token parameter">info</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  window<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'*'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="调试"><a href="#调试" aria-hidden="true" class="header-anchor">#</a> 调试</h2> <p>不管是撸代码的时候还是写完逻辑的时候，我们都期望能根据实际的表现来做出对应的操作，所以就涉及到调试了。Chrome直接支持javascript的调试，拥有了Chrome，就相当于拥有了一个强大的javascript调试器了。</p> <h3 id="调试content-script"><a href="#调试content-script" aria-hidden="true" class="header-anchor">#</a> 调试Content Script</h3> <p>打开开发者工具,点击sources，找到对应的文件-&gt; scripts/index.js，点击打开，就可以和平时调试js一样调试了</p> <h3 id="调试background"><a href="#调试background" aria-hidden="true" class="header-anchor">#</a> 调试Background</h3> <p>由于background和content script并不在同一个运行环境中，因此上面的方法是看不到Background的javascript的。要调试Background，还需要打开插件页，也就是“chrome://extensions”。点对应的插件的“generated background page.html”，就出现了调试窗口，接下来的操作就跟前面的类似了。</p> <h3 id="调试popup"><a href="#调试popup" aria-hidden="true" class="header-anchor">#</a> 调试Popup</h3> <p>虽然Popup和Background是处于同一运行环境中，但在刚才的Background的调试窗口中是看不到Popup的代码的。所以需要审核弹出内容，然后就跟之前的调试操作差不多了</p> <h3 id="调试inject"><a href="#调试inject" aria-hidden="true" class="header-anchor">#</a> 调试inject</h3> <p>inject的话就会把代码注入到网页中，和conten相似的方式即可</p> <h2 id="总结"><a href="#总结" aria-hidden="true" class="header-anchor">#</a> 总结</h2> <p>因为之前没有相关的开发经验，所以开始的时候会有点慌张，怕会延期耽误进度，后来开发完成之后，其实发现只要放平心态，认真仔细的阅读开发文档，做下来还是不难的。通过这次的实践，我差不多已经知道怎么去开发一款chrome插件了，当然，chrom插件的功能是非常强大的，这次用到的仅是冰山一角，要深入，还需要更加充分阅读文档和实践了。
最后，虽然只是开发一个简单的截图工具，还是花费了老大的功夫，果然一入技术深似海，从此头发是路人~~~</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新: </span> <span class="time">2020/2/12 下午6:24:51</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/frontEnd/other/start-vuepress-plugin.html" class="prev">
          vuepress-plugin开发总结
        </a></span> <span class="next"><a href="/frontEnd/other/electron-record.html">
          写一个electron的录屏工具
        </a>
        →
      </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.7355eab2.js" defer></script><script src="/assets/js/2.132a57af.js" defer></script><script src="/assets/js/18.fb2319df.js" defer></script>
  </body>
</html>

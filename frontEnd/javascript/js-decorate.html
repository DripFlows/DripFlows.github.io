<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>初识ES装饰器Decorate | DripFlows</title>
    <meta name="description" content="待补充">
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
    
    <link rel="preload" href="/assets/css/0.styles.28ef1fef.css" as="style"><link rel="preload" href="/assets/js/app.7355eab2.js" as="script"><link rel="preload" href="/assets/js/2.132a57af.js" as="script"><link rel="preload" href="/assets/js/14.6c0337ad.js" as="script"><link rel="prefetch" href="/assets/js/10.740b5f64.js"><link rel="prefetch" href="/assets/js/11.78082b06.js"><link rel="prefetch" href="/assets/js/12.96589dd2.js"><link rel="prefetch" href="/assets/js/13.82b7dda1.js"><link rel="prefetch" href="/assets/js/15.4580a59e.js"><link rel="prefetch" href="/assets/js/16.dd06d4f0.js"><link rel="prefetch" href="/assets/js/17.7ce49614.js"><link rel="prefetch" href="/assets/js/18.fb2319df.js"><link rel="prefetch" href="/assets/js/19.29154b75.js"><link rel="prefetch" href="/assets/js/20.ba78d04c.js"><link rel="prefetch" href="/assets/js/21.edc9c9c6.js"><link rel="prefetch" href="/assets/js/22.777eaed4.js"><link rel="prefetch" href="/assets/js/23.d05fe0b4.js"><link rel="prefetch" href="/assets/js/24.7ae352e2.js"><link rel="prefetch" href="/assets/js/25.f458ff03.js"><link rel="prefetch" href="/assets/js/26.02148a11.js"><link rel="prefetch" href="/assets/js/27.e92b4339.js"><link rel="prefetch" href="/assets/js/28.316df1f3.js"><link rel="prefetch" href="/assets/js/29.7ca7db8a.js"><link rel="prefetch" href="/assets/js/3.4df34556.js"><link rel="prefetch" href="/assets/js/30.eed17a97.js"><link rel="prefetch" href="/assets/js/31.91dad760.js"><link rel="prefetch" href="/assets/js/32.8d597ba3.js"><link rel="prefetch" href="/assets/js/33.16a09da9.js"><link rel="prefetch" href="/assets/js/34.45c4d2e6.js"><link rel="prefetch" href="/assets/js/4.663fdb84.js"><link rel="prefetch" href="/assets/js/5.ed1cff9d.js"><link rel="prefetch" href="/assets/js/6.a180e42e.js"><link rel="prefetch" href="/assets/js/7.101c3ea0.js"><link rel="prefetch" href="/assets/js/8.38b06e0d.js"><link rel="prefetch" href="/assets/js/9.5d56b8fe.js">
    <link rel="stylesheet" href="/assets/css/0.styles.28ef1fef.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">DripFlows</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">🌟博客</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/frontEnd/" class="nav-link router-link-active">前端</a></li><li class="dropdown-item"><!----> <a href="/backEnd/" class="nav-link">后端</a></li><li class="dropdown-item"><!----> <a href="/tools/" class="nav-link">工具</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">💻项目</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/DripFlows/chrome-helper" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Chrome-helper
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div><div class="nav-item"><a href="/suggestions/" class="nav-link">📚推荐</a></div><div class="nav-item"><a href="/todo/" class="nav-link">💡Todo</a></div><div class="nav-item"><a href="https://github.com/DripFlows" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">🌟博客</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/frontEnd/" class="nav-link router-link-active">前端</a></li><li class="dropdown-item"><!----> <a href="/backEnd/" class="nav-link">后端</a></li><li class="dropdown-item"><!----> <a href="/tools/" class="nav-link">工具</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">💻项目</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/DripFlows/chrome-helper" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Chrome-helper
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div><div class="nav-item"><a href="/suggestions/" class="nav-link">📚推荐</a></div><div class="nav-item"><a href="/todo/" class="nav-link">💡Todo</a></div><div class="nav-item"><a href="https://github.com/DripFlows" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/frontEnd/" class="sidebar-link">欢迎</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>JavaScript</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/frontEnd/javascript/svelte-counter.html" class="sidebar-link">svelte尝鲜之计数器</a></li><li><a href="/frontEnd/javascript/js-decorate.html" class="active sidebar-link">初识ES装饰器Decorate</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>TypeScript</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Node</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>React</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Vue</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>杂类</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>算法</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="初识es装饰器decorate"><a href="#初识es装饰器decorate" aria-hidden="true" class="header-anchor">#</a> 初识ES装饰器Decorate</h1> <h3 id="一、引言"><a href="#一、引言" aria-hidden="true" class="header-anchor">#</a> 一、引言</h3> <p>因为最近在公司做一个SKD项目，经常发现要实现很多某些功能相近的逻辑，所以就一直在思考怎么才能减少重复的工作，提提高开发效率。一开始想到的是封装，把逻辑抽象到某个方法中，在需要使用到地方直接调用一下，但是这样又会增加代码的耦合度，并且增加依赖。后面也考虑过函数式编程的高阶函数，高阶函数比函数封装更加简便，但相对的也需要对每个函数多包装一层，开发起来也还是不够灵活。最后想起了es7新出的decorate装饰器，似乎能解决上述的问题，而且写法也比较优雅(主要是逼格高)，然后抱着学习新知识的心态，学习了一下前端装饰器。</p> <h1 id=""><a href="#" aria-hidden="true" class="header-anchor">#</a> <img src="/Users/wuqingfu/Library/Application Support/typora-user-images/image-20200414000037489.png" alt="image-20200414000037489" style="zoom:50%;"></h1> <h3 id="二、什么是装饰器"><a href="#二、什么是装饰器" aria-hidden="true" class="header-anchor">#</a> 二、什么是装饰器</h3> <p>鲁迅曾经说过，人靠衣装，佛靠金装，代码也要能装。</p> <img src="/Users/wuqingfu/Library/Application Support/typora-user-images/image-20200413235823733.png" alt="image-20200413235823733" style="zoom:25%;"> <p>现在走到大街上，不管是打扮漂亮的小改改还是穿着帅气的小阁阁，或者是造型花里胡哨的shamate，都有很高的回头率，这就是装饰的作用，它可以让你即使不整形整容，也能够通过装饰来改变自身的气质。</p> <p>上面扯远了，言归正传。在代码中，装饰器简单来说就是<strong>在不改变对象结构的情况下向一个现有对象添加新的功能</strong>。装饰类和被装饰类互相独立，不会相互耦合，装饰模式是继承的一个替代模式，装饰模式可以动态扩展一个实现类的功能。表现在实际应用中，就可以让开发者很灵活的选择是否需要在class和function中用或者不用某些公用的功能。</p> <h3 id="三、简单用法"><a href="#三、简单用法" aria-hidden="true" class="header-anchor">#</a> 三、简单用法</h3> <p><em>注意： 装饰器还是只是一个es7的提案，使用装饰器需要babel的支持</em></p> <p>因为网上有很多关于装饰器使用的文章，也都比较详细实用，所以本篇就不再做过多的赘述，仅介绍基础的使用，聊聊带过。</p> <ol><li>在class中使用</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// demo1</span>
@testDecorate
<span class="token keyword">class</span> <span class="token class-name">MyTesDecorateClass</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">testDecorate</span><span class="token punctuation">(</span><span class="token parameter">target</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  target<span class="token punctuation">.</span>useDecorate <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
MyTesDecorateClass<span class="token punctuation">.</span>useDecorate <span class="token comment">// true</span>

<span class="token comment">// demo2 demo1添加一个静态属性，如果要添加实例属性，可以通过目标类的prototype对象操作</span>
<span class="token keyword">function</span> <span class="token function">testDecorate</span><span class="token punctuation">(</span><span class="token parameter">target</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  target<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>useDecorate <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
@testable
<span class="token keyword">class</span> <span class="token class-name">MyTesDecorateClass</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyTesDecorateClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
obj<span class="token punctuation">.</span>useDecorate <span class="token comment">// true</span>
</code></pre></div><p><em><strong>Tips:修饰器对类的行为的改变，是代码编译时发生的，而不是在运行时，因为修饰器本质就是编译时执行的函数</strong></em></p> <ol start="2"><li>方法中使用</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// demo1 方法中的简单使用</span>
<span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>
  @readonly
  <span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>first<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>last<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">readonly</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> name<span class="token punctuation">,</span> descriptor</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment">// descriptor对象原来的值如下 - 为什么是这些值呢？先卖个关子，后面再讲。</span>
  <span class="token comment">// {</span>
  <span class="token comment">//   value: specifiedFunction,</span>
  <span class="token comment">//   enumerable: false,</span>
  <span class="token comment">//   configurable: true,</span>
  <span class="token comment">//   writable: true</span>
  <span class="token comment">// };</span>
  descriptor<span class="token punctuation">.</span>writable <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> descriptor<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// demo2 叠加使用</span>
<span class="token keyword">function</span> <span class="token function">dec</span><span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'evaluated'</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> property<span class="token punctuation">,</span> descriptor</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'output'</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">Example</span> <span class="token punctuation">{</span>
    @<span class="token function">dec</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    @<span class="token function">dec</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token function">method</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 输出结果 - 小朋友，看到这个输出顺序，你是否有很多问号？带着这个问号接着往下看吧。</span>
<span class="token comment">// evaluated 1</span>
<span class="token comment">// evaluated 2</span>
<span class="token comment">// output 2</span>
<span class="token comment">// output 1</span>
</code></pre></div><h3 id="四、实际问题中的应用"><a href="#四、实际问题中的应用" aria-hidden="true" class="header-anchor">#</a> 四、实际问题中的应用</h3> <p>有bug的代码千篇一律，优雅的设计万里挑一。接下来看看在实际项目中，使用装饰器对我们的代码有什么提升。</p> <h4 id="_1-react项目开发中的请求loading问题"><a href="#_1-react项目开发中的请求loading问题" aria-hidden="true" class="header-anchor">#</a> 1. react项目开发中的请求loading问题</h4> <p>开发react的小伙伴可能大多数都会遇到组件loading的问题。描述一下场景，一个列表/详情/其他页面，用户点击刷新/查询之后，代码上会触发一个接口请求，为了更好的交互效果，我们通常会在界面上反馈一个loadin的效果，等到接口响应之后取消loading状态，再显示出接口返回的数据，这时候我们就需要维护一个loading的状态。这时候，如果项目中使用的是react+redux的方式开发的，就麻烦了，特别是像我这样的结构</p> <img src="/Users/wuqingfu/Library/Application Support/typora-user-images/image-20200414225145854.png" alt="image-20200414225145854" style="zoom:50%;"> <p>简直是一种折磨，看看在代码中为了一个loading的状态，需要做那几件事情：</p> <ol><li><p>在reducers中定义一下loading这个状态!</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> initalState <span class="token operator">=</span> <span class="token punctuation">{</span>
  loading<span class="token punctuation">:</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> <span class="token function-variable function">Reducer</span> <span class="token operator">=</span> <span class="token punctuation">(</span>
  <span class="token parameter">state <span class="token operator">=</span> initalState<span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    type<span class="token punctuation">,</span>
    payload
  <span class="token punctuation">}</span></span>
<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">default</span><span class="token punctuation">:</span>
      <span class="token keyword">return</span> state
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>在actions中声明一个名为’SET_LAODING_STATE‘的action</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">SET_LOADING_STATE</span> <span class="token operator">=</span> <span class="token string">'SET_LOADING_STATE'</span>
</code></pre></div></li> <li><p>然后sagas中调用接口后再put一个SET_LAODING_STATE去修改loading状态</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 这个方法应该在点击的时候调用的，为了简单展示，就写到这边了～～～</span>
<span class="token keyword">yield</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  type<span class="token punctuation">:</span> actions<span class="token punctuation">.</span><span class="token constant">SET_LOADING_STATE</span><span class="token punctuation">,</span>
  payload<span class="token punctuation">:</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">call</span><span class="token punctuation">(</span>service<span class="token punctuation">.</span>getList<span class="token punctuation">,</span> payload<span class="token punctuation">)</span>
<span class="token keyword">yield</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  type<span class="token punctuation">:</span> actions<span class="token punctuation">.</span><span class="token constant">SET_LOADING_STATE</span><span class="token punctuation">,</span>
  payload<span class="token punctuation">:</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div></li> <li><p>最后在界面中获取loading进行显示。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> loading <span class="token operator">=</span> <span class="token function">useSelector</span><span class="token punctuation">(</span><span class="token parameter">state</span> <span class="token operator">=&gt;</span> state<span class="token punctuation">.</span>common<span class="token punctuation">.</span>loading<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">const</span> <span class="token function-variable function">ListPage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>
	<span class="token operator">&lt;</span>LoadComponent isLoading<span class="token operator">=</span><span class="token punctuation">{</span>loading<span class="token punctuation">}</span><span class="token operator">&gt;</span>
  	<span class="token punctuation">{</span><span class="token operator">*</span> code <span class="token operator">*</span><span class="token punctuation">}</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>LoadComponent<span class="token operator">&gt;</span>
<span class="token punctuation">)</span>

</code></pre></div><p>即使是使用dva的同学，也需要在model中写state和effect等，也是比较烦的。如果有多个界面都需要添加loading状态，那么便需要每个组件都维护一个loading，这样成本就太高了，而且也特别烦。既然那么烦，那我们为什么不把loading做成一个全局的工具呢？</p> <p>首先，来分析一下，怎么做成一个全局的工具，需要做以下工作：</p> <ol><li>首先需要实现一个loading工具 - utils/loading，需要有传入自定key和getLoadingState的能力</li> <li>loading工具可以需要对异步方法进行包装，实现阻塞异步请求对功能</li> <li>组件内通过getLoadingState(key)，获取到对应的loading状态（如果项目中不需要一个页面多个loading，也可以不用对象和key的方式来实现）</li> <li>实现一个装饰器，需要装饰loading的异步方法，使用loading装饰器，在对应的组件中使用loading状态</li></ol> <p>当前，上面的步骤也不是直接想好的，而是根据下面的几个尝试一步一步的优化而来的：</p> <ol><li>尝试一：自己动手写一个类似于dispatch的方法，然后拦截异步，并且自主维护loading状态</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 通过这个方法，来拦截原本的dispatch，加入定制化的内容</span>
<span class="token keyword">function</span> <span class="token operator">*</span> <span class="token function">requestSipn</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> payload <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span>
    timeout<span class="token punctuation">,</span>
  <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">race</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    timeout<span class="token punctuation">:</span> <span class="token function">call</span><span class="token punctuation">(</span>setTimeout<span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 顺手做一下接口防抖</span>
    stop<span class="token punctuation">:</span> <span class="token function">take</span><span class="token punctuation">(</span><span class="token constant">GLOBAL</span><span class="token punctuation">.</span><span class="token constant">REQUEST_FINISH</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">yield</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      type<span class="token punctuation">:</span> actions<span class="token punctuation">.</span><span class="token constant">SET_LOADING_STATE</span><span class="token punctuation">,</span>
      payload<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        loading<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">// 通过REQUEST_FINISH来判断是否已经请求完成</span>
    <span class="token keyword">yield</span> <span class="token function">take</span><span class="token punctuation">(</span><span class="token constant">GLOBAL</span><span class="token punctuation">.</span><span class="token constant">REQUEST_FINISH</span><span class="token punctuation">)</span>
    <span class="token keyword">yield</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      type<span class="token punctuation">:</span> actions<span class="token punctuation">.</span><span class="token constant">SET_LOADING_STATE</span><span class="token punctuation">,</span>
      payload<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        loading<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 野生dispatch</span>
<span class="token keyword">function</span> <span class="token operator">*</span> <span class="token function">dispatchSipn</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> payload <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 这里面传的还是普通dispatch的参数，只不过用dispatchSipn再包装了一下</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> type<span class="token punctuation">,</span> payload <span class="token punctuation">}</span> <span class="token operator">=</span> payload
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">yield</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token punctuation">:</span> actions<span class="token punctuation">.</span><span class="token constant">REQUEST_SPIN</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">// 想法很美好，现实很残忍，代码运行到这边的时候，命运还是忍不住踹了我一jio</span>
    <span class="token comment">// put是saga对Redux中dispatch方法的一个封装，调用put方法后，saga内部会分发action通知Store更新state，所以这边无法监听到异步任务的执行状态，所以此次尝试宣告失败</span>
    <span class="token keyword">yield</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token punctuation">,</span> payload <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">// Tips: 如果是用dva项目的小伙伴，那么这边的方法就可以用，dva的effect中封装了type/@@end和type/@@start 的事件，可以监听某个dispatch是否开始or结束</span>
    <span class="token comment">// yield take(`${type}/@@end`)</span>
    <span class="token comment">// yield put({ type: actions.REQUEST_SPIN })</span>
  <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
    <span class="token keyword">yield</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token constant">GLOBAL</span><span class="token punctuation">.</span><span class="token constant">REQUEST_FINISH</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 模仿一个dispatch</span>
<span class="token keyword">yield</span> <span class="token function">takeLatest</span><span class="token punctuation">(</span><span class="token constant">GLOBAL</span><span class="token punctuation">.</span><span class="token constant">DISPATCH_SIPN</span><span class="token punctuation">,</span> dispatchSipn<span class="token punctuation">)</span>
</code></pre></div><ol start="2"><li>尝试二： 把store暴露到window对象中，然后写一个utils方法，来出发dispatch方法</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// store.js</span>
sagaMiddleware<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>rootSaga<span class="token punctuation">)</span>
window<span class="token punctuation">.</span>__store__ <span class="token operator">=</span> store
<span class="token keyword">export</span> <span class="token keyword">default</span> store

<span class="token comment">// utils/requestWraper.js</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">requestWraper</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 通过柯理化的方式包装request</span>
  <span class="token keyword">return</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>arg</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      window<span class="token punctuation">.</span>__store__<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        type<span class="token punctuation">:</span> <span class="token string">'REQUEST_SPIN'</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token operator">...</span>arg<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      res <span class="token operator">=</span> error
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
      window<span class="token punctuation">.</span>__store__<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        type<span class="token punctuation">:</span> <span class="token string">'requestFinish'</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> res
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 这是基于尝试一暴露出去的野生dispatch</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">dispatchSipn</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> type<span class="token punctuation">,</span> payload <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  window<span class="token punctuation">.</span>__store__<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    type<span class="token punctuation">:</span> <span class="token string">'dispatchSipn'</span><span class="token punctuation">,</span>
    payload<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      type<span class="token punctuation">,</span>
      body<span class="token punctuation">:</span> payload
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 用法</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token operator">*</span> <span class="token function">watchLoadSaga</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">yield</span> <span class="token function">takeLatest</span><span class="token punctuation">(</span>actions<span class="token punctuation">.</span><span class="token constant">REQUEST_SPIN</span><span class="token punctuation">,</span> <span class="token function">requestWraper</span><span class="token punctuation">(</span>asyncFunc<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ol> <p>通过上面的展示，会发现用这种高阶函数包装的方法，也能够很快速的解决上述的场景。当然，用高阶函数灵活度还是不够，而且需要对每个方法进行包裹，所以还没有达到预期效果。所以我们只能鸡蛋里挑骨头，继续优化我们的代码了，这时候就轮到文章的主角登场了。</p> <ol start="3"><li><p>尝试三，使用装饰器方案来替代高阶函数的方案</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// requestWraper 和上面的一致</span>
@<span class="token function">requestWraper</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// Tips 因为js中函数存在变量提示的问题，所以装饰器只能在方法中使用</span>
<span class="token function">toDoSaync</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> payload <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// async to do</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// error hint</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>通过这个方案，是不是既实现了上面高阶函数的功能，又让代码显得更优雅了呢，并且，使用这种方式，也能解决页面中有多个loading的尴尬场景，就是利用对象，定义一个独享的key来做到分组件loading，当然，也可以通过这个例子做更进一步的拓展，比如实现截流防抖装饰器，还有其他就需要同学们自己去创新了。</p> <p>简单总结一下，通过上面的例子，可以简单的看出：<em><strong>装饰器 = 高阶函数 + 函数嵌套 + 闭包</strong></em>，因为装饰器本质上也是一个高阶函数，而且比高阶函数的写法更加简洁明了优雅且无侵入。</p></li></ol> <h4 id="_2-node的restful-api项目中的使用"><a href="#_2-node的restful-api项目中的使用" aria-hidden="true" class="header-anchor">#</a> 2. node的RESTful API项目中的使用</h4> <p>通过上面loading例子，我们简单的了解了装饰器在项目中的作用，但是要求比较高的同学会说：那其实也没什么嘛，我用高阶函数也能做的到，而且改起来也不复杂。好的，那我们就带着这个问题，来看下面稍微复杂一点的node接口项目场景吧。</p> <p><strong>项目说明</strong></p> <p>利用node+koa2+typescript搭建的接口服务项目，通过以下四个点来举例来说明</p> <p><strong>功能描述</strong></p> <ul><li>jwt身份验证</li> <li>请求参数验证</li> <li>分模块路由</li> <li>请求方式</li></ul> <h5 id="在使用装饰器之前的写法"><a href="#在使用装饰器之前的写法" aria-hidden="true" class="header-anchor">#</a> 在使用装饰器之前的写法</h5> <ol><li>实现jwt校验中间件，因为身份校验是一个全局的校验，如果在每个请求中都写一次的话，那也太蠢了，所以直接通过实现一个koa请求中间件的方式来做身份校验</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token function">request</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">:</span> ParameterizedContext<span class="token punctuation">,</span> next<span class="token punctuation">:</span> Function<span class="token punctuation">)</span><span class="token punctuation">:</span> Promise<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果是接口的话，需要校验用户权限 判断请求路径是否是 localhost/api/xxxxxx</span>
    <span class="token keyword">const</span> isApiRquest <span class="token operator">=</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'api'</span>
    <span class="token keyword">const</span> correctAuthorization <span class="token operator">=</span> isApiRquest <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">jwtVerify</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token boolean">false</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isApiRquest <span class="token operator">&amp;&amp;</span> correctAuthorization<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 处理用户请求参数</span>
      <span class="token keyword">const</span> userParam <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">formatParams</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> correctAuthorization<span class="token punctuation">)</span>
      <span class="token comment">// 校验用户请求参数</span>
      <span class="token keyword">const</span> correctParam <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">verifyParameters</span><span class="token punctuation">(</span>userParam<span class="token punctuation">,</span> ctx<span class="token punctuation">)</span>
      <span class="token comment">// 参数校验通过，才到下一个中间件</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>correctParam<span class="token punctuation">)</span> <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 不是接口请求，直接跳过此中间件</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isApiRquest<span class="token punctuation">)</span> <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 使用中间件，直接在全局应用一下，这样的话，就可以不用在没次请求中加上身份校验的校验，但是这也会有个问题，就是有些路由是不需要身份校验的，需要添加一个白名单。</span>
app
  <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>requestMiddleware<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>api<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>api<span class="token punctuation">.</span><span class="token function">allowedMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><ol start="2"><li>请求方式和模块</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> Controller <span class="token keyword">from</span> <span class="token string">'../controller/index'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/getList'</span><span class="token punctuation">,</span> Controller<span class="token punctuation">.</span>getList<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 请求方式 localhost[:port]/api/路由模块/getList</span>
</code></pre></div><ol start="3"><li>请求参数校验 - 以一个列表get请求为例子</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// router.ts 需要先判断请求的参数</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>
  startTime<span class="token punctuation">,</span>
  endTime<span class="token punctuation">,</span>
  <span class="token operator">...</span>otherQuery
<span class="token punctuation">}</span> <span class="token operator">=</span> ctx<span class="token punctuation">.</span>query<span class="token punctuation">;</span>
<span class="token keyword">const</span> query <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">...</span>ctx<span class="token punctuation">.</span>query <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// 列表请求需要 开始时间-结束时间-分页数据-其他的查询参数（空值传参过滤）</span>
<span class="token keyword">const</span> <span class="token punctuation">[</span>options<span class="token punctuation">,</span> skip<span class="token punctuation">,</span> limit<span class="token punctuation">,</span> result<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">disposeGetListQuery</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// RequestControllerAbstract.ts 继承的抽象类</span>
<span class="token keyword">public</span> <span class="token function">disposeGetListQuery</span> <span class="token punctuation">(</span>query<span class="token punctuation">:</span> GetListQuery<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>object<span class="token punctuation">,</span> number<span class="token punctuation">,</span> number<span class="token punctuation">,</span> object<span class="token punctuation">]</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>query <span class="token operator">||</span> <span class="token keyword">typeof</span> query <span class="token operator">!==</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> startTime<span class="token punctuation">,</span> endTime<span class="token punctuation">,</span> pageSize<span class="token punctuation">,</span> pageNum <span class="token punctuation">}</span> <span class="token operator">=</span> query<span class="token punctuation">;</span>
  <span class="token keyword">const</span> num <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span>pageNum<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> limit <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span>pageSize<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token number">20</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> skip <span class="token operator">=</span> <span class="token punctuation">(</span>num <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> limit<span class="token punctuation">;</span>
  <span class="token keyword">const</span> ignoreList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'startTime'</span><span class="token punctuation">,</span> <span class="token string">'endTime'</span><span class="token punctuation">,</span> <span class="token string">'pageNum'</span><span class="token punctuation">,</span> <span class="token string">'pageSize'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">// 吧其他参数包装起来-顺便过滤空值传参</span>
  <span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// 这边只做了个简单的空值过滤，实际场景中，还会有请求参数类型和格式还有值的要求，这边就不详细展开了</span>
    <span class="token operator">...</span><span class="token function">filterNullValue</span><span class="token punctuation">(</span>query<span class="token punctuation">,</span> ignoreList<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>startTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    options<span class="token punctuation">[</span><span class="token string">'time'</span><span class="token punctuation">]</span> <span class="token operator">=</span> options<span class="token punctuation">.</span>time <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    options<span class="token punctuation">[</span><span class="token string">'time'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'$gte'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>startTime<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>endTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    options<span class="token punctuation">[</span><span class="token string">'time'</span><span class="token punctuation">]</span> <span class="token operator">=</span> options<span class="token punctuation">.</span>time <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    options<span class="token punctuation">[</span><span class="token string">'time'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'$lte'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>endTime<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 定义返回数据</span>
  <span class="token keyword">const</span> result<span class="token punctuation">:</span> ListReturnData <span class="token operator">=</span> <span class="token punctuation">{</span>
    total<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    pageSize<span class="token punctuation">:</span> limit<span class="token punctuation">,</span>
    pageNum<span class="token punctuation">:</span> num<span class="token punctuation">,</span>
    list<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token comment">// 列表请求接口一般也要做好分页功能，所以这边直接把分页的内容返回过去</span>
  <span class="token keyword">return</span> <span class="token punctuation">[</span>options<span class="token punctuation">,</span> skip<span class="token punctuation">,</span> limit<span class="token punctuation">,</span> result<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>通过上面的代码可以看到，如果我需要处理这些公共的参数，那么我必须要入侵到代码里面，在业务代码中调用这些公用的方法，而且这边还没包含post请求的场景，因为get请求和post请求，传参的位置不一样，到时候就需要更多的代码来实现一个参数校验的功能。再一个就是不够灵活，如果传参内容有变化，那就需要在代码中进行改动，这样就导致我们会被这样的工作占据很多时间，不利于我们学习其他新知识（划水）或者代码优化（摸鱼）。所以呢，还需要对代码做进一步的改进，于是就引出了下面的代码。</p> <h5 id="使用装饰器之后的写法"><a href="#使用装饰器之后的写法" aria-hidden="true" class="header-anchor">#</a> 使用装饰器之后的写法</h5> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 路由</span>
@<span class="token function">Controller</span><span class="token punctuation">(</span><span class="token string">'/test'</span><span class="token punctuation">)</span> <span class="token comment">// 定义了是那个模块</span>
<span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">{</span>
  @<span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/getList/:id22'</span><span class="token punctuation">)</span> <span class="token comment">// 直接定义了接口名和参数</span>
  @<span class="token function">RequestHeaders</span><span class="token punctuation">(</span>ReqHeaders<span class="token punctuation">)</span> <span class="token comment">// 某些接口为了安全，会在header中一些隐私数据</span>
  @<span class="token function">RequestQuery</span><span class="token punctuation">(</span>ReqQuery<span class="token punctuation">)</span> <span class="token comment">// 校验请求参数</span>
  @<span class="token function">RequestQuery</span><span class="token punctuation">(</span>ListReqParams<span class="token punctuation">)</span> <span class="token comment">// 可以校验多个点（也可以在一个中传对象，这边写出来只是为了提升一下逼格）</span>
  @<span class="token function">Paging</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//是否要分页</span>
  @<span class="token function">auth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 请求这个接口是否需要校验身份</span>
  <span class="token keyword">async</span> <span class="token function">getList</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">:</span> ParameterizedContext<span class="token punctuation">,</span> next<span class="token punctuation">:</span> Function</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 通过分页包装后，就可以直接在这边拿到分页参数了</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token punctuation">{</span>
      total<span class="token punctuation">:</span> <span class="token punctuation">[</span>total<span class="token punctuation">]</span> 根据查询条件<span class="token punctuation">,</span>
      pageNum<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pageNum<span class="token punctuation">,</span>
      pageSize<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pageSize<span class="token punctuation">,</span>
      list<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment">// 通过数据库查询获取</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">handleRespose</span><span class="token punctuation">(</span><span class="token string">'success'</span><span class="token punctuation">,</span> ctx<span class="token punctuation">,</span> result<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 请求方式 localhost[:port]/api/test/getList/111</span>

<span class="token comment">// 补充一：如何实现授权装饰器</span>
<span class="token keyword">class</span> <span class="token class-name">Request</span> <span class="token punctuation">{</span>
  <span class="token keyword">public</span> <span class="token function">auth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">:</span> any<span class="token punctuation">,</span> name<span class="token operator">?</span><span class="token punctuation">:</span> string<span class="token punctuation">,</span> descriptor<span class="token operator">?</span><span class="token punctuation">:</span> IDescriptor</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> target <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">&amp;&amp;</span> name <span class="token operator">===</span> <span class="token keyword">undefined</span> <span class="token operator">&amp;&amp;</span> descriptor <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 装饰类</span>
        target<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>baseAuthMidws <span class="token operator">=</span> <span class="token keyword">super</span><span class="token punctuation">.</span>verifyAuthMiddleware<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> target <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> name <span class="token operator">&amp;&amp;</span> descriptor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 装饰类方法</span>
        descriptor<span class="token punctuation">.</span>value<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>baseAuthMidws <span class="token operator">=</span> <span class="token keyword">super</span><span class="token punctuation">.</span>verifyAuthMiddleware<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 最终对外暴露的装饰器</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> auth <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">auth</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 补充二：如果动态导入路由</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">(</span>dir<span class="token punctuation">:</span> string <span class="token operator">=</span> <span class="token string">'../api'</span><span class="token punctuation">,</span> filePattern<span class="token operator">?</span><span class="token punctuation">:</span> RegExp<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 根据规则，找到api/目录下的所有文件，把这些代码注册为路由文件</span>
  util<span class="token punctuation">.</span><span class="token function">exportFile</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span> filePattern<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> rootRouter
<span class="token punctuation">}</span>
<span class="token comment">// index.ts中</span>
<span class="token keyword">import</span> decoratorRouter <span class="token keyword">from</span> <span class="token string">'./decorator/router'</span>
<span class="token keyword">const</span> route <span class="token operator">=</span> <span class="token function">decoratorRouter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app
  <span class="token comment">// .use(requestMiddleware) // 就不需要通过这种中间件的方式来处理权限校验了</span>
  <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>route<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>route<span class="token punctuation">.</span><span class="token function">allowedMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>可以看出，如果使用装饰器来实现功能的话，我们的代码就会变得更加灵活。业务和功能也会变得更加分离，在实现好功能代码之后，后续的开发就不需要在新路由中操心传参等功能性问题了，让我们的代码更加优质的服务于业务开发。也能够让功能和业务的逻辑更加清晰，提高我们的开发效率。</p> <p>好了，通过这两个例子，大家应该能体会到装饰器在我们实际项目中的妙用了，那既然我们已经会用了，那我们不禁会想：</p> <ul><li>装饰器是怎么工作的？</li> <li>为什么能实现这么花里胡哨的效果？</li></ul> <h3 id="五、浅析装饰器原理"><a href="#五、浅析装饰器原理" aria-hidden="true" class="header-anchor">#</a> 五、浅析装饰器原理</h3> <p>知其然，顺便知其所以然。当我们学会使用装饰器之后，我们如果要用的更好，那势必要去了解一下装饰器的基本工作原理，接下来咱们就一起来简单看看它的实现源码。</p> <h4 id="decorate-js："><a href="#decorate-js：" aria-hidden="true" class="header-anchor">#</a> decorate.js：</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 通过这边可以看出来，decorator其实是一个语法糖，作用于对象的属性时，实质利用了Object.defineProperty方法，这边也就能解释 三-2中的问题了</span>

<span class="token comment">// descriptor-属性描述符。对象里目前存在的属性描述符有两种主要形式：数据描述符和存取描述符。数据描述符是一个具有值的属性，该值可能是可写的，也可能不是可写的。存取描述符是由 getter-setter 函数对描述的属性</span>
<span class="token comment">// </span>
<span class="token keyword">function</span> <span class="token function">handleDescriptor</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> descriptor<span class="token punctuation">,</span> <span class="token punctuation">[</span>decorator<span class="token punctuation">,</span> <span class="token operator">...</span>args<span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 结构属性描述符descriptor 通常用来改变默认的属性访问</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> configurable<span class="token punctuation">,</span> enumerable<span class="token punctuation">,</span> writable <span class="token punctuation">}</span> <span class="token operator">=</span> descriptor<span class="token punctuation">;</span>
  <span class="token comment">// 接收原本的get/set方法和值</span>
  <span class="token keyword">const</span> originalGet <span class="token operator">=</span> descriptor<span class="token punctuation">.</span>get<span class="token punctuation">;</span>
  <span class="token keyword">const</span> originalSet <span class="token operator">=</span> descriptor<span class="token punctuation">.</span>set<span class="token punctuation">;</span>
  <span class="token keyword">const</span> originalValue <span class="token operator">=</span> descriptor<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
  <span class="token keyword">const</span> isGetter <span class="token operator">=</span> <span class="token operator">!</span><span class="token operator">!</span>originalGet<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    configurable<span class="token punctuation">,</span>
    enumerable<span class="token punctuation">,</span>
    <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 对函数进行装饰，也可以认为是包装，本质上就是在原来函数/类的基础上，植入了装饰器的代码</span>
      <span class="token keyword">const</span> fn <span class="token operator">=</span> isGetter <span class="token operator">?</span> <span class="token function">originalGet</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> originalValue<span class="token punctuation">;</span>
      <span class="token keyword">const</span> value <span class="token operator">=</span> <span class="token function">decorator</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> fn<span class="token punctuation">,</span> <span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>isGetter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> value<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> desc <span class="token operator">=</span> <span class="token punctuation">{</span>
          configurable<span class="token punctuation">,</span>
          enumerable
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        desc<span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
        desc<span class="token punctuation">.</span>writable <span class="token operator">=</span> writable<span class="token punctuation">;</span>
        <span class="token comment">// es7装饰器的本质</span>
        Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> desc<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> value<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">set</span><span class="token punctuation">:</span> isGetter <span class="token operator">?</span> originalSet <span class="token punctuation">:</span> <span class="token function">createDefaultSetter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">decorate</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">_decorate</span><span class="token punctuation">(</span>handleDescriptor<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>通过上面的代码，就会发现我们用装饰器的时候就相当于给把代码再裹上一层外套，最后裹的一层一层像个洋葱，即koa2中的洋葱模型，这样就会导致三-2中输出顺序的问题了。看完上面的代码之后，接下来再一起看下 createDefaultSetter方法和_decorate方法：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// createDefaultSetter 重置set方法</span>
<span class="token keyword">function</span> <span class="token function">createDefaultSetter</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token keyword">set</span><span class="token punctuation">(</span><span class="token parameter">newValue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      configurable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 设置该属性可配置，避免封闭</span>
      writable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 设置为可写</span>
      enumerable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 设置为可被</span>
      value<span class="token punctuation">:</span> newValue
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> newValue<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>其实createDefaultSetter就是在属性没有set的情况，创造一个set方法。而_decorate做的也是相似，类/方法本身是不支持装饰器的，通过这个把属性描述符包装进去，实现装饰器效果。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// _decorate</span>
<span class="token keyword">function</span> <span class="token function">_decorate</span><span class="token punctuation">(</span><span class="token parameter">handleDescriptor<span class="token punctuation">,</span> entryArgs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDescriptor</span><span class="token punctuation">(</span>entryArgs<span class="token punctuation">[</span>entryArgs<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">handleDescriptor</span><span class="token punctuation">(</span><span class="token operator">...</span>entryArgs<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">handleDescriptor</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span><span class="token punctuation">,</span> entryArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>看完_decorate之后，再来看下它是怎么判断的</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">isDescriptor</span><span class="token punctuation">(</span><span class="token parameter">desc</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>desc <span class="token operator">||</span> <span class="token operator">!</span>desc<span class="token punctuation">.</span>hasOwnProperty<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> keys <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'value'</span><span class="token punctuation">,</span> <span class="token string">'initializer'</span><span class="token punctuation">,</span> <span class="token string">'get'</span><span class="token punctuation">,</span> <span class="token string">'set'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">=</span> keys<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>desc<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>keys<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>看完isDescriptor是不是知道了，原来它判断的代码，是不是有种俺也能写的感觉呢，哈哈哈哈，不过虽然我们都能写，但并不一定都能想到要怎么写，很多时候编程还是由思维来主导的。</p> <h4 id="applydecorators"><a href="#applydecorators" aria-hidden="true" class="header-anchor">#</a> applyDecorators</h4> <p>源码中是这么定义的 Helper to apply decorators to a class without transpiler support</p> <p>译为：在不支持转换的情况下在class中使用装饰器</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> defineProperty<span class="token punctuation">,</span> getOwnPropertyDescriptor <span class="token punctuation">}</span> <span class="token operator">=</span> Object<span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">applyDecorators</span><span class="token punctuation">(</span><span class="token parameter">Class<span class="token punctuation">,</span> props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> prototype <span class="token punctuation">}</span> <span class="token operator">=</span> Class<span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> props<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> decorators <span class="token operator">=</span> props<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">=</span> decorators<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> decorator <span class="token operator">=</span> decorators<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token comment">// 利用js原型链的特性来实现效果</span>
      <span class="token function">defineProperty</span><span class="token punctuation">(</span>prototype<span class="token punctuation">,</span> key<span class="token punctuation">,</span>
        <span class="token function">decorator</span><span class="token punctuation">(</span>
          prototype<span class="token punctuation">,</span>
          key<span class="token punctuation">,</span> 
          <span class="token function">getOwnPropertyDescriptor</span><span class="token punctuation">(</span>prototype<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> Class<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>限于本人的技术水平，源码分析到这边就结束了。其实装饰器是一个很大的体系，还可以挖掘的点有很多，比如说属性描述符descriptor，有兴趣的小伙伴可以再继续深入了解。</p> <h3 id="六、结束语"><a href="#六、结束语" aria-hidden="true" class="header-anchor">#</a> 六、结束语</h3> <p><em>因为个人技术水平有限，所以文中可能会有些错误，欢迎各位大佬批评指正</em></p> <p>当我们学习一段新知识的时候，需要先在我们思维上构建一个“认知概念”，我们会先尝试去认识、了解并且使用它，然后掌握基本操作和使用，然后深入了解，最后创新和改良。因为技术有限，所以这篇文章讲到掌握基本使用方法，后续待使用得更加深入之后，再做进一步的分享吧。</p> <p>矫情一句：一如编程深似海，从此飘柔是路人～～～</p> <p>最后，送给大家一个表情包以做结尾</p> <img src="/Users/wuqingfu/Library/Application Support/typora-user-images/image-20200415235135048.png" alt="image-20200415235135048" style="zoom:50%;"></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新: </span> <span class="time">2020/5/12 下午3:27:34</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/frontEnd/javascript/svelte-counter.html" class="prev">
          svelte尝鲜之计数器
        </a></span> <span class="next"><a href="/frontEnd/typescript/generic.html">
          TS泛型积累
        </a>
        →
      </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.7355eab2.js" defer></script><script src="/assets/js/2.132a57af.js" defer></script><script src="/assets/js/14.6c0337ad.js" defer></script>
  </body>
</html>
